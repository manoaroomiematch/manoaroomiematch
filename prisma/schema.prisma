generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL")
  directUrl = env("POSTGRES_URL_NON_POOLING")
}

enum Role {
  USER
  ADMIN
}

model User {
  id                Int                @id @default(autoincrement())
  email             String              @unique
  password          String
  role              Role                @default(USER)
  profile           UserProfile?
  
  // Moderation fields
  active            Boolean             @default(true)
  suspendedUntil    DateTime?
  suspensionCount   Int                 @default(0)
  lastLogin         DateTime?
  
  // New relations from ER diagram
  flags_reported    Flag[]              @relation("ReportedByUser")
  flags_against     Flag[]              @relation("ReportedUser")
  notifications     Notification[]
  responses         LifestyleResponse[]
  sentMessages      Message[]           @relation("Sender")
  recdMessages      Message[]           @relation("Receiver")
  moderationActions ModerationAction[]  @relation("AdminModerator")
  targetActions     ModerationAction[]  @relation("TargetUser")
}

model UserProfile {
  id              String   @id @default(cuid())
  userId          Int      @unique
  user            User     @relation(fields: [userId], references: [id])
  name            String
  firstName       String?  // Added
  lastName        String?  // Added
  pronouns        String?
  bio             String?
  email           String
  photoUrl        String?
  major           String?
  classStanding   String?
  graduationYear  Int?
  needRoommateBy  DateTime?
  instagram       String?
  snapchat        String?
  hometown        String?
  createdAt       DateTime @default(now())
  
  // Housing preferences
  housingType      String?  // 'on-campus', 'off-campus', 'either', 'undecided'
  preferredDorm    String?
  specificBuilding String?
  budget           String?
  
  sleepSchedule   Int      @default(3)
  cleanliness     Int      @default(3)
  noiseLevel      Int      @default(3)
  socialLevel     Int      @default(3)
  guestFrequency  Int      @default(3)
  temperature     Int      @default(3)
  
  smoking         Boolean  @default(false)
  drinking        String   @default("occasionally")
  pets            Boolean  @default(false)
  petTypes        String[]
  dietary         String[]
  interests       String[]
  workSchedule    String   @default("day")
  
  preferences     Json     @default("{}")
  
  matchesAsUser1  Match[]  @relation("User1Matches")
  matchesAsUser2  Match[]  @relation("User2Matches")
}

model Match {
  id                   String   @id @default(cuid())
  user1Id              String
  user2Id              String
  overallScore         Int
  categoryScores       Json
  compatibilityReport  String?
  icebreakers          String[]
  status               String   @default("pending")
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  
  user1                UserProfile @relation("User1Matches", fields: [user1Id], references: [id])
  user2                UserProfile @relation("User2Matches", fields: [user2Id], references: [id])
  aiExplanation        AIExplanation?

  @@unique([user1Id, user2Id])
}

// --- New Models from ER Diagram ---

model Flag {
  id               Int      @id @default(autoincrement())
  reported_by_user_id Int
  reported_user_id Int
  reason           String
  status           String   @default("pending")
  created_at       DateTime @default(now())

  reported_by_user User @relation("ReportedByUser", fields: [reported_by_user_id], references: [id])
  reported_user    User @relation("ReportedUser", fields: [reported_user_id], references: [id])

  @@unique([reported_by_user_id, reported_user_id])
  @@index([reported_user_id])
  @@index([status])
}

model Notification {
  id          Int      @id @default(autoincrement())
  user_id     Int
  user        User     @relation(fields: [user_id], references: [id])
  type        String
  content     String
  is_read     Boolean  @default(false)
  created_at  DateTime @default(now())
}

model AIExplanation {
  id                    Int      @id @default(autoincrement())
  match_id              String   @unique
  match                 Match    @relation(fields: [match_id], references: [id])
  strengths_text        String?
  conflicts_text        String?
  suggestions_text      String?
  first_message_template String?
  created_at            DateTime @default(now())
}

model Message {
  id          Int      @id @default(autoincrement())
  senderId    Int
  receiverId  Int
  content     String
  sentAt      DateTime @default(now())
  
  // Add these new fields for read tracking
  isRead      Boolean  @default(false)
  readAt      DateTime?

  sender   User @relation("Sender", fields: [senderId], references: [id])
  receiver User @relation("Receiver", fields: [receiverId], references: [id])
  
  // Added these indexes for better performance
  @@index([senderId, receiverId, sentAt])
  @@index([receiverId, senderId, sentAt])
  @@index([receiverId, isRead])
}

model LifestyleCategory {
  id          Int      @id @default(autoincrement())
  name        String
  description String?
  is_active   Boolean  @default(true)
  updatedAt   DateTime @updatedAt
  questions   LifestyleQuestion[]
}

model LifestyleQuestion {
  id            Int      @id @default(autoincrement())
  category_id   Int
  category      LifestyleCategory @relation(fields: [category_id], references: [id])
  question_text String
  input_type    String
  order_index   Int
  is_active     Boolean  @default(true)
  options       LifestyleOption[]
  responses     LifestyleResponse[]
}

model LifestyleOption {
  id          Int      @id @default(autoincrement())
  question_id Int
  question    LifestyleQuestion @relation(fields: [question_id], references: [id])
  label       String
  value       String
  order_index Int
  responses   LifestyleResponse[]
}

model LifestyleResponse {
  id          Int      @id @default(autoincrement())
  user_id     Int
  user        User     @relation(fields: [user_id], references: [id])
  question_id Int
  question    LifestyleQuestion @relation(fields: [question_id], references: [id])
  option_id   Int?
  option      LifestyleOption? @relation(fields: [option_id], references: [id])
  free_text   String?
  created_at  DateTime @default(now())
}

model ModerationAction {
  id            Int      @id @default(autoincrement())
  targetUserId  Int
  adminUserId   Int
  action        String   // 'resolve', 'suspend', 'deactivate', 'reactivate'
  durationHours Int?     // For suspensions, duration in hours (null for other actions)
  notes         String?
  flagId        Int?     // Reference to the flag that triggered this action
  createdAt     DateTime @default(now())

  targetUser    User     @relation("TargetUser", fields: [targetUserId], references: [id])
  adminUser     User     @relation("AdminModerator", fields: [adminUserId], references: [id])
}

